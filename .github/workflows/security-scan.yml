name: Security Scan

on:
  workflow_call:
    inputs:
      language:
        description: 'Language for CodeQL analysis (javascript, python, java, or auto)'
        required: false
        type: string
        default: 'auto'
      skip-codeql:
        description: 'Skip CodeQL SAST analysis'
        required: false
        type: boolean
        default: false
      skip-dependency-review:
        description: 'Skip dependency review (SCA)'
        required: false
        type: boolean
        default: false
      skip-secrets:
        description: 'Skip secret scanning'
        required: false
        type: boolean
        default: false
      skip-iac:
        description: 'Skip IaC scanning'
        required: false
        type: boolean
        default: false
      skip-container:
        description: 'Skip container scanning'
        required: false
        type: boolean
        default: false
      skip-sbom:
        description: 'Skip SBOM generation'
        required: false
        type: boolean
        default: false
      skip-license:
        description: 'Skip license checking'
        required: false
        type: boolean
        default: false
      dockerfile-path:
        description: 'Path to Dockerfile for container scanning'
        required: false
        type: string
        default: './Dockerfile'
      working-directory:
        description: 'Working directory for commands'
        required: false
        type: string
        default: '.'
      timeout-minutes:
        description: 'Job timeout in minutes'
        required: false
        type: number
        default: 45

permissions:
  contents: read

concurrency:
  group: security-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  codeql-analysis:
    name: CodeQL SAST
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-codeql }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Detect CodeQL language
        id: detect-lang
        working-directory: ${{ inputs.working-directory }}
        run: |
          LANG="${{ inputs.language }}"
          if [ "$LANG" = "auto" ]; then
            if [ -f "package.json" ]; then
              LANG="javascript"
            elif [ -f "requirements.txt" ] || [ -f "setup.py" ] || [ -f "pyproject.toml" ]; then
              LANG="python"
            elif [ -f "pom.xml" ] || [ -f "build.gradle" ]; then
              LANG="java"
            else
              LANG="javascript"
            fi
          fi
          echo "language=$LANG" >> $GITHUB_OUTPUT
          echo "::notice::CodeQL language: $LANG"

      - name: Initialize CodeQL
        uses: github/codeql-action/init@094128488009d3c9f8a950abffa9976b2a8837ed # v3.24.0
        with:
          languages: ${{ steps.detect-lang.outputs.language }}
          queries: security-extended,security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@094128488009d3c9f8a950abffa9976b2a8837ed # v3.24.0

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@094128488009d3c9f8a950abffa9976b2a8837ed # v3.24.0
        with:
          category: "/language:${{ steps.detect-lang.outputs.language }}"
          upload: true

  dependency-review:
    name: Dependency Review (SCA)
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-dependency-review && github.event_name == 'pull_request' }}
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Dependency Review
        uses: actions/dependency-review-action@9129d7d40b8c12c1ed0f60400d00c92d437adcce # v4.1.3
        with:
          fail-on-severity: moderate
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, 0BSD

  secret-scanning:
    name: Secret Scanning
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-secrets }}
    timeout-minutes: 15
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@cb7149a9b57195b609c63e8518d2c6056677d2d0 # v2.3.3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_ENABLE_SUMMARY: true
          GITLEAKS_ENABLE_UPLOAD_ARTIFACT: false

  iac-scanning:
    name: IaC Security Scan
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-iac }}
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@b466648d6e39e7c75324f25d83891162a721f2d6 # v1.0.3
        with:
          soft_fail: true
          format: sarif
          additional_args: --out tfsec-results.sarif
        continue-on-error: true

      - name: Upload tfsec SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@094128488009d3c9f8a950abffa9976b2a8837ed # v3.24.0
        with:
          sarif_file: tfsec-results.sarif
          category: tfsec
        continue-on-error: true

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@1004385eeaf0b1f134060b0019f568b78fe119eb # v12.2701.0
        with:
          directory: ${{ inputs.working-directory }}
          framework: all
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
        continue-on-error: true

      - name: Upload Checkov SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@094128488009d3c9f8a950abffa9976b2a8837ed # v3.24.0
        with:
          sarif_file: checkov-results.sarif
          category: checkov
        continue-on-error: true

  container-scanning:
    name: Container Security Scan
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-container }}
    timeout-minutes: 20
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Check if Dockerfile exists
        id: check-dockerfile
        run: |
          if [ -f "${{ inputs.dockerfile-path }}" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "::notice::Dockerfile found at ${{ inputs.dockerfile-path }}"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "::warning::Dockerfile not found at ${{ inputs.dockerfile-path }}, skipping container scan"
          fi

      - name: Build Docker image
        if: steps.check-dockerfile.outputs.exists == 'true'
        run: |
          docker build -f ${{ inputs.dockerfile-path }} -t test-image:${{ github.sha }} .

      - name: Run Trivy vulnerability scanner
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@fd25fed6972e341ff0007ddb61f77e88103953c2 # v0.21.0
        with:
          image-ref: test-image:${{ github.sha }}
          format: sarif
          output: trivy-results.sarif
          severity: CRITICAL,HIGH,MEDIUM
          timeout: 10m

      - name: Upload Trivy SARIF
        if: steps.check-dockerfile.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@094128488009d3c9f8a950abffa9976b2a8837ed # v3.24.0
        with:
          sarif_file: trivy-results.sarif
          category: trivy

  sbom-generation:
    name: SBOM Generation
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-sbom }}
    timeout-minutes: 15
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Generate SBOM with Syft
        uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0.21.1
        with:
          path: ${{ inputs.working-directory }}
          format: cyclonedx-json
          output-file: sbom.cyclonedx.json
          upload-artifact: false

      - name: Generate SPDX SBOM
        uses: anchore/sbom-action@0b82b0b1a22399a1c542d4d656f70cd903571b5c # v0.21.1
        with:
          path: ${{ inputs.working-directory }}
          format: spdx-json
          output-file: sbom.spdx.json
          upload-artifact: false

  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip-license }}
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          persist-credentials: false

      - name: Setup Node.js for license check
        uses: actions/setup-node@b39b52d1213e96004bfcb1c61a8a6fa8ab84f3e8 # v4.0.1
        with:
          node-version: '20'

      - name: Check Node.js licenses
        if: hashFiles('package.json') != ''
        working-directory: ${{ inputs.working-directory }}
        run: |
          npm install -g license-checker
          license-checker --summary || true
          license-checker --json --out licenses.json || true
        continue-on-error: true

      - name: Setup Python for license check
        if: hashFiles('requirements.txt', 'setup.py', 'pyproject.toml') != ''
        uses: actions/setup-python@0a5c61591373683505ea898e09a3ea4f39ef2b9c # v5.0.0
        with:
          python-version: '3.11'

      - name: Check Python licenses
        if: hashFiles('requirements.txt', 'setup.py', 'pyproject.toml') != ''
        working-directory: ${{ inputs.working-directory }}
        run: |
          pip install pip-licenses
          pip-licenses --format=json --output-file=python-licenses.json || true
        continue-on-error: true

      - name: Upload license reports
        uses: actions/upload-artifact@26f96dfa697d77e81fd5907df203aa23a56210a8 # v4.3.0
        with:
          name: license-reports
          path: |
            licenses.json
            python-licenses.json
          retention-days: 30
          if-no-files-found: ignore
